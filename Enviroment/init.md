# Setup Enviroment

VmWare Workstation 17.5 and distro Ubuntu 22.04

Pi zero 2w build from yocto with armv7l architechture

## I. SOC: Pi Zero 2W Enviroment

### Yocto Enviroment

1. Install dependence package in ubuntu
``` bash
sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
     build-essential chrpath socat cpio python python3 python3-pip python3-pexpect \
     xz-utils debianutils iputils-ping libsdl1.2-dev xterm vim
```

and

``` bash
sudo apt install gawk wget git diffstat unzip texinfo gcc build-essential chrpath socat \
cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping \
python3-git python3-jinja2 python3-subunit zstd liblz4-tool file locales libacl1
```

2. Clone source poky (In pi zero 2w should try on `master` branch):
``` bash
git clone git://git.yoctoproject.org/poky
```

3. Clone source meta-layer for raspberry (In pi zero 2w should try on `master` branch):

``` bash
~/poky$ git clone git://git.yoctoproject.org/meta-raspberrypi
```

4. Clone source meta-openembedded (In pi zero 2w should try on `master` branch):

``` bash
~/poky$ git clone git://git.openembedded.org/meta-openembedded
```

5. Config build:

In `conf/local.conf` change machine to 

``` bash
MACHINE ?= "raspberrypi0-2w"
```
In `conf/bblayers.conf` add layer:

``` bash
BBLAYERS ?= " \
  /home/long/yocto/poky/meta \
  /home/long/yocto/poky/meta-poky \
  /home/long/yocto/poky/meta-yocto-bsp \
  /home/long/yocto/poky/meta-raspberrypi \
  /home/long/yocto/poky/meta-openembedded/meta-oe \
  /home/long/yocto/poky/meta-openembedded/meta-multimedia\
  /home/long/yocto/poky/build/workspace \
  "
```

6. Bitbake:

``` bash
~/poky$ source oe-init-build-env

~/poky/build$ bitbake core-image-sato
```

After build success, image file in the location `~/poky/build/tmp/deploy/images/build/tmp/deploy/images/`

Find the file containing image is bziped, it will look like this:`core-image-sato-raspberrypi0-2w.rootfs-XXXXXXXX.wic.bz2`

### Setup UART and command line

1. Modify file `/boot/cmdline.txt`

Add `console=serial0,115200` and `rcmfmac.feature_disable=0x82000` after `rootwait`
``` text
dwc_otg.lpm_enable=0 root=/dev/mmcblk0p2 rootfstype=ext4 rootwait modules-load=dwc2,g_ether console=serial0,115200 net.ifnames=0 brcmfmac.feature_disable=0x82000
```

2. Add a config in the end of file `/boot/config.txt`
``` text
enable_uart=1
```

### Setup wpa_supplicant for wifi ssh conection

1. Create empty file `ssh` in `/boot`

``` bash
/boot$ touch ssh
```

2. Create file `wpa_supplicant.conf` with below content

``` bash
country=VN
ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=0
update_config=1

network={
    ssid="<your_home_wifi_name>"
    psk="<your_home_wifi_password>"
}
```

Copy and paste it on the path of SOC:


`/etc/wpa_supplicant/wpa_supplicant.conf`

`/etc/wpa_supplicant.conf`

`/boot/wpa_supplicant.conf`

3. Create a `network_source.sh` with below content:

``` bash
#!/bin/bash
echo "Enable pizero 2w wifi module"

# turn off power saving mode
iw dev wlan0 set power_save off

# setup network
killall wpa_supplicant
rm -f /var/run/wpa_supplicant/wlan0
rfkill unblock wifi
wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf -D nl80211,wext
udhcpc -i wlan0
```

4. Add DNS server 8.8.8.8 in the head of the file `/etc/resolv.conf` like this

``` bash
# Generated by Connection Manager
nameserver 8.8.8.8
nameserver ::1
nameserver 127.0.0.1

```

After finish setup, try run script `network_source.sh` after start poweron pi zero 2w (by uart comand line)

### Setup some receipt built:

Add a these setting on the end of file `yocto/poky/build/conf`

``` bash
INHERIT += "rm_work"
IMAGE_INSTALL:append = " git rsync tar sed vim openssh openssh-sftp-server net-tools \
	bzip2 \
	libgcrypt \
	libgpg-error \
	zlib \
	libassuan \
	gnupg \
	gcc gdb bison gperf \
	boost \
	udev \
	libinput \
	tslib \
	mtdev \
	libjpeg-turbo \
	fontconfig \
	dbus \
	glib-2.0 \
	libxkbcommon \
	mesa \
	alsa-lib \
	pulseaudio \
	gstreamer1.0 gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-plugins-base-app gstreamer1.0-plugins-good-video4linux2 \
	libvpx libvpx-dev \
	libsrtp \
	snappy \
	nss \
	libxcb xcb-util xcb-util-image xcb-util-keysyms xcb-util-renderutil \
	flex \
	libxslt \
	ruby \
	cups \
	atkmm \
	libxi \
	libxcomposite \
	freetype \
	icu \
	sqlite3 \
	ffmpeg-dev \
	libx11-dev libxext-dev libxrender-dev \
	libxcb-dev libxi-dev libxrandr-dev libxcursor-dev \
	libxcomposite-dev libxdamage-dev libxscrnsaver-dev \
	libxtst-dev libpciaccess-dev libcap-dev libdrm-dev \
	at-spi2-core-dev libxkbcommon-dev \
	directfb-dev alsa-lib-dev pulseaudio-dev postgresql-dev \
	libiodbc-dev gstreamer1.0-dev \
    "

LICENSE_FLAGS_ACCEPTED = "synaptics-killswitch commercial"
# Maximize memory savings (lower values)
# BB_NUMBER_THREADS = "8"
# PARALLEL_MAKE = "-j 8"

IMAGE_FEATURES:remove = "ssh-server-dropbear"

PACKAGE_CLASSES = "package_deb"
EXTRA_IMAGE_FEATURES += "package-management"

DISTRO_FEATURES:append = " systemd usrmerge"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""
VIRTUAL-RUNTIME_login_manager = "systemd"
```


### Setup Qt Enviroment

<span style="font-size:23px"><strong>IMPORTANT: From here we should create a user and should not use <code>root</code>.</strong></span>
```bash
adduser <USER>
usermod -aG sudo <GROUP>
passwd <USER>
```


for more information look at page: 

`https://wiki.qt.io/Cross-Compile_Qt_6_for_Raspberry_Pi`

or

`https://github.com/0xgram/Cross-Compiling-Qt-for-Raspberry-Pi-Zero-2W`

0. Setup package management:

check gpg

``` bash
gpg --version
```

if gpg not show, you need to reinstall receipt `gnupg` by modify `local.conf`

``` bash
IMAGE_INSTALL:append = " git rsync tar sed vim openssh openssh-sftp-server net-tools \
	bzip2 \
	libgcrypt \
	libgpg-error \
	zlib \
	libassuan \
	gnupg \
	gcc gdb bison gperf \
    "
```

1. Set source apt `debian 12: bookworm`:

``` bash
sudo vim /etc/apt/sources.list
```
 add bellow these line
``` bash

# Debian Main Repositories
deb-src http://deb.debian.org/debian/ bookworm main contrib non-free
 
# Debian Security Updates
deb-src http://security.debian.org/debian-security bookworm-security main contrib non-free
 
# Debian Updates
deb-src http://deb.debian.org/debian/ bookworm-updates main contrib non-free
```

Save and close file then run bellow comand:

``` bash
sudo apt-get update
sudo apt-get dist-upgrade
sudo reboot
```

Note: if show error of no verification key, you need to download key (change key 9165938D90FDDD2E to your key):

``` bash
wget -O - "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x9165938D90FDDD2E" | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/raspbian.gpg > /dev/null
```

2. Create a directory for the Qt install

```bash
sudo mkdir -p /usr/local/qt6
sudo chown -R long:long /usr/local/qt6

sudo mkdir -p /opt/vc
sudo chown long:long /opt*
```

note: replace `long`:`long` as your `USER`:`GROUP`

### Setup Host Ubuntu 22.04 Enviroment



1. First update package:

```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install gcc git bison python gperf pkg-config gdb-multiarch
sudo apt install build-essential
```
2. Setup directory structure:

```bash
mkdir ~/rpi
mkdir ~/rpi/build-rpi
mkdir ~/rpi/build-ubuntu
mkdir ~/rpi/tools
mkdir ~/rpi/sysroot
mkdir ~/rpi/sysroot/usr
mkdir ~/rpi/sysroot/opt
chown -R 1000:1000 ~/rpi
cd ~/rpi
```

3. Install Qt 6.5.3 version:

```bash
cd ~/rpi

wget https://qt.mirror.constant.com/archive/qt/6.5/6.5.3/single/qt-everywhere-src-6.5.3.tar.xz
tar xfv qt-everywhere-src-6.5.3.tar.xz && rm -rfv qt-everywhere-src-6.5.3.tar.xz

cp -R qt-everywhere-src-6.5.3/qtbase/mkspecs/linux-arm-gnueabi-g++ qt-everywhere-src-6.5.3/qtbase/mkspecs/linux-arm-gnueabihf-g++

sed -i -e 's/arm-linux-gnueabi-/arm-linux-gnueabihf-/g' qt-everywhere-src-6.5.3/qtbase/mkspecs/linux-arm-gnueabihf-g++/qmake.conf
```

4. Download the cross-compiler

``` bash
cd ~/rpi/tools

wget https://releases.linaro.org/components/toolchain/binaries/7.4-2019.02/arm-linux-gnueabihf/gcc-linaro-7.4.1-2019.02-x86_64_arm-linux-gnueabihf.tar.xz

tar xfv gcc-linaro-7.4.1-2019.02-x86_64_arm-linux-gnueabihf.tar.xz && rm -rfv gcc-linaro-7.4.1-2019.02-x86_64_arm-linux-gnueabihf.tar.xz

```

5. rsync sysroot with pi zero 2w:

```bash
cd ~/rpi
rsync -avz --rsync-path="sudo rsync" --delete long@192.168.1.7:/lib sysroot
rsync -avz --rsync-path="sudo rsync" --delete long@192.168.1.7:/usr/include sysroot/usr
rsync -avz --rsync-path="sudo rsync" --delete long@192.168.1.7:/usr/lib sysroot/usr
rsync -avz --rsync-path="sudo rsync" --delete long@192.168.1.7:/opt/vc sysroot/opt
```

6. Must fix: remove Simbolic link

``` bash
wget https://raw.githubusercontent.com/riscv/riscv-poky/master/scripts/sysroot-relativelinks.py

sudo chmod +x sysroot-relativelinks.py

python3 ./sysroot-relativelinks.py sysroot
```

## II. MCU:STM32F415RGTX 

1. Prepare STM32CubeIDE 1.19.0 

2. Open STM32CubeIDE and login account -> update package library